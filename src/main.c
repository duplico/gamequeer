#include <stdint.h>
#include <stdlib.h>
#include <unistd.h>

#include "gamequeer.h"

#include "gfx.h"
#include "grlib.h"
#include "grlib_gfx.h"

Graphics_Context g_sContext;

#define SCREEN_W 128
#define SCREEN_H 128

const uint32_t palette_bw[] = {0x000000, 0xffffff};
const uint32_t palette_wb[] = {0xffffff, 0x000000};

static const uint8_t pixel_fingerprint_1BPP_UNCOMP[] = {
    0b11111111, 0b11111111, 0b11111111, 0b11111111, 0b11111111, 0b11111111, 0b11111111, 0b11111111, 0b11111111,
    0b11111111, 0b11111111, 0b11111011, 0b11110111, 0b11111111, 0b11111111, 0b11111111, 0b11111111, 0b11111111,
    0b11111111, 0b11101110, 0b11011100, 0b00111111, 0b11111111, 0b11111111, 0b11111111, 0b11111111, 0b11111111,
    0b11010011, 0b00100111, 0b11000111, 0b11111111, 0b11111111, 0b11111111, 0b11111111, 0b11111111, 0b11101000,
    0b11111000, 0b01111111, 0b11111111, 0b11111111, 0b11111111, 0b11111111, 0b11111111, 0b10010111, 0b10111111,
    0b10000000, 0b00111111, 0b11111111, 0b11111111, 0b11111111, 0b11111111, 0b00111101, 0b11011100, 0b11111111,
    0b11111111, 0b11111111, 0b11111111, 0b11111111, 0b11111100, 0b11000111, 0b01100111, 0b00000111, 0b11111111,
    0b11111111, 0b11111111, 0b11111111, 0b11110111, 0b01111001, 0b10111001, 0b11111111, 0b11100111, 0b11111111,
    0b11111111, 0b11111111, 0b11111100, 0b01000110, 0b11001111, 0b10001110, 0b11101111, 0b11111111, 0b11111111,
    0b11111111, 0b11110011, 0b10111001, 0b11111001, 0b11111111, 0b11111111, 0b11111111, 0b11111111, 0b11111111,
    0b11101110, 0b01110110, 0b01001111, 0b00011111, 0b11111111, 0b11111111, 0b11111111, 0b11111111, 0b11111011,
    0b10011011, 0b00110001, 0b11111000, 0b00000111, 0b11111111, 0b11111111, 0b11111111, 0b01100111, 0b01101101,
    0b10011100, 0b00011110, 0b00111110, 0b11111111, 0b11111111, 0b11111111, 0b10011101, 0b10011000, 0b11100111,
    0b11111111, 0b11111001, 0b11111111, 0b11111111, 0b11111110, 0b00100111, 0b01100110, 0b00111000, 0b11111000,
    0b00011111, 0b01111111, 0b11111111, 0b11111110, 0b11001100, 0b10011001, 0b10001110, 0b00100111, 0b11111001,
    0b10111111, 0b11111111, 0b11111111, 0b10110011, 0b01101100, 0b01100011, 0b11111111, 0b00100011, 0b01111111,
    0b11111111, 0b11111110, 0b11011110, 0b11010111, 0b00011111, 0b10000001, 0b11011101, 0b11011111, 0b11111111,
    0b11111101, 0b11110111, 0b00101000, 0b11000111, 0b11111111, 0b01110111, 0b01101111, 0b11111111, 0b11100111,
    0b10011110, 0b11011111, 0b00111001, 0b11111001, 0b11001101, 0b11011111, 0b11111111, 0b11111100, 0b11100111,
    0b01100110, 0b11001110, 0b01010011, 0b11110111, 0b01101111, 0b11111111, 0b11110011, 0b10010000, 0b10011011,
    0b00110000, 0b00000111, 0b11001101, 0b11011111, 0b11111111, 0b11100110, 0b01100100, 0b01101100, 0b10011001,
    0b11111100, 0b01111110, 0b01101111, 0b11111111, 0b11011001, 0b10011011, 0b00110110, 0b11000111, 0b11111001,
    0b11110011, 0b11110111, 0b11111111, 0b10110110, 0b01101100, 0b10010011, 0b00110000, 0b10001111, 0b10001110,
    0b11101111, 0b11111111, 0b11101101, 0b10011011, 0b01101101, 0b10011111, 0b11111110, 0b01111011, 0b10110111,
    0b11111111, 0b10010011, 0b01100100, 0b10110110, 0b11100011, 0b11110011, 0b11001111, 0b11111111, 0b11111111,
    0b01100001, 0b10011011, 0b01011011, 0b00110000, 0b00011111, 0b01111011, 0b10110111, 0b11111111, 0b10011011,
    0b00110101, 0b00101100, 0b10011111, 0b11111100, 0b11101110, 0b11111111, 0b11111111, 0b00110100, 0b11011010,
    0b11010110, 0b11001111, 0b11110011, 0b10011001, 0b10110111, 0b11111110, 0b11001101, 0b10110101, 0b01011010,
    0b01100111, 0b11100111, 0b01100110, 0b11001011, 0b11111101, 0b10110010, 0b11111011, 0b10101101, 0b10100000,
    0b00011101, 0b11011001, 0b10110111, 0b11111110, 0b01101001, 0b01111111, 0b11110111, 0b00011111, 0b11111011,
    0b10110110, 0b01101011, 0b11111100, 0b10010010, 0b11110101, 0b01011110, 0b11011111, 0b10000110, 0b01101101,
    0b10110111, 0b11111011, 0b01101111, 0b11011010, 0b10111011, 0b11101111, 0b10111110, 0b11011011, 0b01111111,
    0b11111100, 0b11010111, 0b11110101, 0b11111101, 0b00110011, 0b11111101, 0b11100110, 0b11111111, 0b11111011,
    0b10101111, 0b11011010, 0b11011100, 0b11001111, 0b11110011, 0b00111011, 0b01101011, 0b11110110, 0b11010111,
    0b01110111, 0b10101010, 0b01111111, 0b11100110, 0b01101111, 0b11110111, 0b11111011, 0b01101010, 0b10101011,
    0b11101101, 0b10001111, 0b11011110, 0b10010101, 0b10101011, 0b11111100, 0b10010111, 0b01011110, 0b11010010,
    0b01100010, 0b00110011, 0b00101011, 0b01111111, 0b11111001, 0b01101001, 0b10111101, 0b11101101, 0b10111000,
    0b00110110, 0b11011010, 0b11111011, 0b11110110, 0b11010101, 0b11011010, 0b11111110, 0b11001111, 0b11101101,
    0b10111101, 0b11110101, 0b11101001, 0b00101101, 0b10110111, 0b11111101, 0b11111100, 0b00011011, 0b01011010,
    0b01011011, 0b11110110, 0b11010011, 0b01100111, 0b11111111, 0b11111111, 0b11100110, 0b10101101, 0b10101111,
    0b11101101, 0b00100110, 0b11011111, 0b11111111, 0b11111111, 0b11111011, 0b01111111, 0b11010111, 0b11111011,
    0b01010011, 0b10101111, 0b11111111, 0b11111111, 0b11110110, 0b01111101, 0b01101011, 0b11100100, 0b10101100,
    0b11010111, 0b11111111, 0b11111111, 0b11101011, 0b11110110, 0b11110101, 0b11011101, 0b01110011, 0b10111111,
    0b11111111, 0b11111111, 0b11100101, 0b11101111, 0b01111011, 0b11101010, 0b01110100, 0b11101111, 0b10000000,
    0b00000011, 0b11110111, 0b11010101, 0b10111111, 0b11011110, 0b11011110, 0b00111111, 0b10000000, 0b00000011,
    0b11110101, 0b10101010, 0b01011101, 0b10110101, 0b01101101, 0b11011111, 0b10000000, 0b00000011, 0b11110110,
    0b01010101, 0b11101011, 0b11001010, 0b10110110, 0b01101111, 0b10000000, 0b00000011, 0b11100111, 0b10010110,
    0b11011111, 0b10110111, 0b11011011, 0b10110111, 0b11111111, 0b11111111, 0b11111001, 0b01101001, 0b01010101,
    0b11101111, 0b00001101, 0b11011111, 0b11111111, 0b11111111, 0b11110111, 0b01111010, 0b10101011, 0b11010110,
    0b10111110, 0b11011111, 0b11111111, 0b11111111, 0b11110111, 0b01010111, 0b11101111, 0b10101111, 0b10011010,
    0b11001111, 0b10000000, 0b00000011, 0b11110110, 0b10100101, 0b01010101, 0b11011010, 0b01011011, 0b01001111,
    0b10000000, 0b00000011, 0b11101101, 0b10101011, 0b11111101, 0b11110101, 0b01101111, 0b01001111, 0b10000000,
    0b00000011, 0b11101101, 0b01100001, 0b11101011, 0b10101101, 0b11101111, 0b01001111, 0b10000000, 0b00000011,
    0b11101101, 0b01011101, 0b11001011, 0b11010101, 0b10101101, 0b01101111, 0b11111111, 0b11111111, 0b11111101,
    0b11011101, 0b10110111, 0b11110110, 0b10101011, 0b01011111, 0b11111111, 0b11111111, 0b11110101, 0b11011001,
    0b00111111, 0b11101010, 0b10101010, 0b11011111, 0b11111111, 0b11111111, 0b11110110, 0b10110011, 0b01101011,
    0b11011010, 0b10111010, 0b10111111, 0b11111111, 0b11111111, 0b11111110, 0b10110110, 0b11011111, 0b11101010,
    0b10110110, 0b10101111, 0b11111111, 0b11111111, 0b11101010, 0b10110111, 0b11010111, 0b11011010, 0b10100101,
    0b01010111, 0b11111111, 0b11111111, 0b11001010, 0b10110110, 0b11001111, 0b11110001, 0b11101110, 0b00100010,
    0b11110001, 0b10111001, 0b01010101, 0b11011100, 0b11011111, 0b11001101, 0b11101011, 0b00001101, 0b11001111,
    0b01011010, 0b10110101, 0b11011101, 0b10011111, 0b11111010, 0b11010101, 0b01110011, 0b01101001, 0b10101101,
    0b11101011, 0b01011101, 0b10111111, 0b11111101, 0b01101010, 0b11010101, 0b11111110, 0b11011010, 0b11011101,
    0b01101101, 0b10111111, 0b11110110, 0b11110111, 0b01100011, 0b00000011, 0b00100100, 0b10110111, 0b11101111,
    0b00101111, 0b11111001, 0b10011111, 0b01011100, 0b00000001, 0b10011011, 0b01011010, 0b11011110, 0b01111111,
    0b11110111, 0b11110111, 0b11110001, 0b11111100, 0b11100110, 0b10110111, 0b01101110, 0b11011111, 0b11111101,
    0b11111100, 0b11011111, 0b11011111, 0b00011011, 0b01101010, 0b11010010, 0b11111111, 0b11111111, 0b10111011,
    0b10111110, 0b11010000, 0b11001110, 0b11011100, 0b10101100, 0b10111111, 0b11111101, 0b11110110, 0b11101101,
    0b01111001, 0b00110001, 0b10110101, 0b01110101, 0b11111111, 0b11111111, 0b11101101, 0b11011011, 0b11111111,
    0b11100110, 0b11011111, 0b10111101, 0b01111111, 0b11111111, 0b10110111, 0b10110110, 0b11111111, 0b00010011,
    0b11101101, 0b01010010, 0b11111111, 0b11111111, 0b11101111, 0b11101101, 0b11000000, 0b01011110, 0b10111111,
    0b00111111, 0b11111111, 0b11111110, 0b00111001, 0b10111101, 0b11111100, 0b00100110, 0b00011011, 0b00111111,
    0b11111111, 0b11111111, 0b10001110, 0b01110111, 0b11111111, 0b11100111, 0b11100000, 0b10000111, 0b11111111,
    0b11111111, 0b11110001, 0b11101110, 0b00000111, 0b11111000, 0b11111111, 0b11101111, 0b11111111, 0b11111111,
    0b11011110, 0b01111001, 0b10110000, 0b00111110, 0b01111111, 0b11111111, 0b11111111, 0b11111111, 0b11111011,
    0b00111100, 0b01111111, 0b11101111, 0b11000001, 0b11111111, 0b11111111, 0b11111111, 0b11011110, 0b11100111,
    0b11011111, 0b11110001, 0b11110111, 0b11111111, 0b11111111, 0b11111111, 0b11110111, 0b10111000, 0b11110000,
    0b00001111, 0b00011111, 0b11111111, 0b11111111, 0b11111111, 0b11111111, 0b11110111, 0b10011100, 0b11111111,
    0b11111111, 0b11111111, 0b11111111, 0b11111111, 0b11111111, 0b11011100, 0b11110111, 0b10000001, 0b11111111,
    0b11111111, 0b11111111, 0b11111111, 0b11111111, 0b11100111, 0b11111100, 0b11111111, 0b11000001, 0b11111111,
    0b11111111, 0b11111111, 0b11111111, 0b00111101, 0b11011111, 0b11000001, 0b11111111, 0b11111111, 0b11111111,
    0b11111111, 0b11111111, 0b11001111, 0b11111000, 0b11111111, 0b11111111, 0b11111111, 0b11111111, 0b11111111,
    0b11111111, 0b11111000, 0b11111111, 0b10000000, 0b11111111, 0b11111111, 0b11111111, 0b11111111, 0b11111111,
    0b11111111, 0b11000000, 0b11111111, 0b11111111, 0b11111111, 0b11111111, 0b11111111, 0b11111111, 0b11111111,
    0b11111111, 0b11111111, 0b11111111, 0b11111111, 0b11111111,
};

const Graphics_Image fingerprint_1BPP_UNCOMP = {
    IMAGE_FMT_1BPP_UNCOMP,
    64,
    94,
    2,
    palette_wb,
    pixel_fingerprint_1BPP_UNCOMP,
};

#define CART_FLASH_SIZE_MBYTES 16
#define SAVE_FLASH_SIZE_MBYTES 16

uint8_t s_clicked   = 0;
uint8_t s_anim_done = 0;

uint8_t flash_cart[CART_FLASH_SIZE_MBYTES * 1024 * 1024];
uint8_t flash_save[SAVE_FLASH_SIZE_MBYTES * 1024 * 1024];
uint8_t flash_fram[512];

uint8_t read_byte(t_gq_pointer ptr) {
    switch (GQ_PTR_NS(ptr)) {
        case GQ_PTR_NS_CART:
            return flash_cart[ptr & ~GQ_PTR_NS_MASK];
        case GQ_PTR_NS_SAVE:
            return flash_save[ptr & ~GQ_PTR_NS_MASK];
        case GQ_PTR_NS_FRAM:
            return flash_fram[ptr & ~GQ_PTR_NS_MASK];
        case GQ_PTR_NS_FBUF:
            return 0; // TODO: Implement framebuffer
        default:
            return 0;
    }
}

uint8_t write_byte(t_gq_pointer ptr, uint8_t value) {
    switch (GQ_PTR_NS(ptr)) {
        case GQ_PTR_NS_CART:
            flash_cart[ptr & ~GQ_PTR_NS_MASK] = value;
            return 1;
        case GQ_PTR_NS_SAVE:
            flash_save[ptr & ~GQ_PTR_NS_MASK] = value;
            return 1;
        case GQ_PTR_NS_FRAM:
            flash_fram[ptr & ~GQ_PTR_NS_MASK] = value;
            return 1;
        case GQ_PTR_NS_FBUF:
            return 0; // TODO: Implement framebuffer
        default:
            return 0;
    }
}

uint8_t gq_memcpy(t_gq_pointer dest, t_gq_pointer src, uint32_t size) {
    for (t_gq_pointer i = 0; i < size; i++) {
        if (!write_byte(dest + i, read_byte(src + i))) {
            return 0;
        }
    }
    return 1;
}

void HAL_init() {
    gfx_driver_init("Gamequeer");
    Graphics_initContext(&g_sContext, &g_gfx);

    // TODO: Load the binary file cart image from the command line
    // TODO: Load the binary file local mem image from the command line
}

void HAL_event_poll() {
    static char c;
    c = gfx_getKey(); // returns 0 if no key pressed, 1,2,3 for mouse buttons, or ascii code of keyboard character
    switch (c) {
        case 'a': // "left"
            break;
        case 'd': // "right"
            break;
        case 'k': // "a"
            break;
        case 'l': // "b"
            break;
        case ' ': // "click"
            s_clicked = 1;
            break;
    }
}

void HAL_sleep() {
    usleep(10000); // pause for number of milliseconds before repeating
}

void init() {
    HAL_init();

    Graphics_setForegroundColor(&g_sContext, ClrWhite);
    Graphics_setBackgroundColor(&g_sContext, ClrBlack);
    Graphics_setFont(&g_sContext, &g_sFontFixed6x8);
    Graphics_clearDisplay(&g_sContext);

    // TODO: load the local starting stage
}

int main() {
    init();
    // TODO: Add the LEDs
    // TODO: Load the starting animation
    while (1) {
        // Perform the current animation step
        // TODO
        Graphics_drawImage(&g_sContext, &fingerprint_1BPP_UNCOMP, 0, 0);
        Graphics_drawString(&g_sContext, "Hello, world!", -1, 0, 96, false);

        // Perform polling for other event sources
        HAL_event_poll();

        ////////// Handle events //////////
        // Animation done
        if (s_anim_done) {
            // Handle the animation done event.
            // TODO: implement
            s_anim_done = 0;
        }
        // Button pressed (A, B, left, right, click)
        if (s_clicked) {
            // Handle the click; quit the game.
            exit(0);
            s_clicked = 0;
        }

        HAL_sleep();
    }
}
